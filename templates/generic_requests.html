{% extends "base.html" %}

{% load static from staticfiles %}

{% block headers %}
<script type="text/javascript" src="{% static 'tinymce/tinymce.min.js' %}"></script>
<script type="text/javascript" src="{% static 'tinymce/requests.js' %}"></script>
<link type="text/css" rel="stylesheet" href="{% static 'ui/css/content.css' %}" />
<link type="text/css" rel="stylesheet" href="{% static 'ui/css/generic_requests.css' %}" />
{% endblock %}

{% block content %}
<script>
  function show_new_request_form() {
  document.getElementById("new_request_form").style.display="inline";
  }
  function hide_new_request_form() {
  document.getElementById("new_request_form").style.display="none";
  }
  function show_new_response_form(response_form_id, button_id) {
  document.getElementById(response_form_id).style.display="inline";
  document.getElementById(button_id).style.display="none";
  }
  function hide_new_response_form(response_form_id, button_id) {
  document.getElementById(response_form_id).style.display="none";
  document.getElementById(button_id).style.display="inline";
  }
</script>
<div class="requests">
  <div class="table_header">
    <input class="btn btn-primary btn-lg add_request" onclick="show_new_request_form()" type="submit" value="New Request" />
    <h3 class="requests_title">Recent {{ request_type }} Requests</h3>
  </div> <!-- table_header -->
  <form id="new_request_form" method="post" action="">
    {% csrf_token %}
    <table id="new_request_table">
      {{ request_form.as_table }}
    </table>
    <div class="container-fluid">
      <div class="row">
	<div class="col-md-6">
	  <input class="btn btn-primary btn-lg" id="submit_request_form" name="submit_request" type="submit" value="Submit Request" />
	</div>
	<div class="col-md-6">
	  <input class="btn btn-default btn-lg" id="cancel_request_form" onclick="hide_new_request_form()" type="button" value="Cancel" />
	</div>
      </div>
    </div> <!-- container-fluid -->
  </form>

  <div class="container-fluid requests_table">
    {% if not all_requests %}
    <div class="field_wrapper">No {{ request_type }} requests found.</div>
    {% else %}
    {% for request in all_requests %}
    {% if forloop.counter > 1 %}
    <hr/>
    {% endif %}

    <div class="requests_row">
      <div class="request_name">
	<div class="request_owner">
	  {% if request.filled %}
	  <img src="{% static 'admin/img/icon-yes.gif' %}" alt="Filled"/>
	  {% elif request.closed %}
	  <img src="{% static 'admin/img/icon-no.gif' %}" alt="Closed">
	  {% endif %}
	  <a class="page_link" href="{% url 'member_profile' targetUsername=request.owner.user.username %}" >
	    {% if request.owner.user == user %}You{% else %}{{ request.owner.user.first_name }} {{ request.owner.user.last_name }}{% endif %}</a>
	  ({{ request.post_date }}):
	</div> <!-- request_owner -->
	<hr class="response_divider" />
	<div class="request_body">{{ request.body|safe }}</div>
      </div> <!-- request_name -->

      <div class="request_responses">
	<div class="response_table">
	  {% for response in all_responses %}
	  {% if response.request == request %}
	  {% if forloop.counter > 1 %}
	  <hr id="response_divider" />
	  {% endif %}
	  <div class="response_row{% if response.manager %} manager_response{% endif %}">
	    <div class="response_owner">
	      <a class="page_link" href="{% url 'member_profile' targetUsername=response.owner.user.username %}" >
		{% if response.owner.user == user %}You{% else %}{{ response.owner.user.first_name }} {{ response.owner.user.last_name }}{% endif %}
	      </a> ({{ response.post_date }}):
	    </div> <!-- response_owner -->
	    <hr class="response_divider" />
	    <div class="response_body">
	      {{ response.body|safe }}
	    </div> <!-- response_body -->
	  </div> <!-- response_row -->
	  {% endif %}
	  {% endfor %}

	  <div class="text-center">
	    {% with y=forloop.counter|stringformat:"s" %}
	    {% with response_form_id="response_form_"|add:y %}
	    {% with button_id="button_"|add:y %}
	    <input class="btn btn-lg btn-primary" type="button" id="{{ button_id }}" onclick="show_new_response_form('{{ response_form_id }}', '{{ button_id }}')" value="Add Response to Thread" />
	    <form class="new_response_form add_response" id="{{ response_form_id }}" method="post" action="">
	      {% csrf_token %}
	      {% for response_form in response_forms %}
	      {% if response_form.request_pk.value == request.pk %}
	      {{ response_form.request_pk }}
	      <textarea class="response" name="body"></textarea>
	      {% if manager %}
	      <div class="checkbox"><label for="id_mark_filled">Filled</label>
		{{ response_form.mark_filled }}
	      </div>
	      <div class="checkbox"><label for="id_mark_closed">Closed</label>
		{{ response_form.mark_closed }}
	      </div>
	      {% endif %}
	      <div class="container-fluid">
		<div class="row">
		  <div class="col-md-6">
		    <input class="btn btn-lg btn-primary" name="add_response" type="submit" value="Post Message" />
		  </div>
		  <div class="mol-md-6">
		    <input class="btn btn-lg btn-default" onclick="hide_new_response_form('{{ response_form_id }}', '{{ button_id }}')" type="button" value="Cancel" />
		  </div>
		</div>
	      </div> <!-- container-fluid -->
	      {% endif %}
	      {% endfor %}
	    </form>
	    {% endwith %}
	    {% endwith %}
	    {% endwith %}
	  </div> <!-- response_row -->
	</div> <!-- response_table -->
      </div> <!-- request_name -->
    </div> <!-- requests_row -->
    {% endfor %}
    {% endif %}
  </div>
  <!-- <div class="more_requests"><a href="{% url 'food_requests' %}" >See All Requests</a></div> -->
</div>
{% endblock %}
